<div class="min-h-screen bg-background">
  <!-- Marketplace Navbar -->
  <app-marketplace-navbar></app-marketplace-navbar>
  
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header -->
    <div class="mb-8">
      <h1 class="text-2xl md:text-3xl font-display font-bold text-primary">Meus Pedidos</h1>
      <p class="text-base text-gray-600 mt-2">Acompanhe o histórico e status das suas entregas</p>
    </div>

    <!-- Loading State -->
    <div *ngIf="loading" class="space-y-6">
      <app-skeleton-loader *ngFor="let i of [1,2,3]" type="card"></app-skeleton-loader>
    </div>

    <!-- Empty State -->
    <app-empty-state *ngIf="!loading && orders.length === 0"
                     title="Nenhum Pedido Encontrado"
                     message="Você ainda não realizou nenhum pedido. Explore nosso catálogo e faça sua primeira compra!"
                     [actionLabel]="'Explorar Catálogo'"
                     [actionHandler]="goToCatalog.bind(this)">
    </app-empty-state>

    <!-- Orders List (Grouped by Date) -->
    <div *ngIf="!loading && groupedOrders.length > 0" class="space-y-8">
      <div *ngFor="let group of groupedOrders" class="space-y-4">
        <!-- Date Header -->
        <div class="flex items-center gap-4">
          <h2 class="text-lg font-semibold text-gray-900">{{ group.date }}</h2>
          <div class="h-px flex-1 bg-gray-200"></div>
        </div>

        <!-- Orders for this date -->
        <div *ngFor="let order of group.orders; let i = index" 
             class="bg-white rounded-lg shadow-sm border border-l-4 transition-all duration-200 hover:shadow-md"
             [ngClass]="getStatusBorderColor(order.status)">
          
          <!-- Compact Order Content -->
          <div class="p-4">
            <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
              
              <!-- Left: Identifier & Status -->
              <div class="flex-1 min-w-0">
                <div class="flex items-center gap-3 mb-2">
                  <h3 class="text-base font-bold text-gray-900">
                    {{ getOrderDisplayNumber(order) }}
                  </h3>
                  <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium capitalize border"
                        [ngClass]="getStatusClass(order.status)">
                    {{ getStatusLabel(order.status) }}
                  </span>
                </div>
                
                <!-- Secondary Info: Time & Company -->
                <div class="flex flex-wrap items-center gap-x-4 gap-y-1 text-sm text-gray-500">
                  <div class="flex items-center gap-1.5" title="Data e Horário do Pedido">
                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span>Pedido: <strong>{{ formatDateTime(order.created_at) || formatDateTime(order.delivery_date) }}</strong></span>
                  </div>

                  <span class="hidden md:inline text-gray-300">|</span>

                  <div class="flex items-center gap-1.5" title="Data e Horário de Entrega">
                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                    <span>Entrega: <strong>{{ formatDateTime(order.actual_delivery_date) || formatDateTime(order.delivery_date) || '-' }}</strong></span>
                  </div>
                  
                  <span *ngIf="order.account_name" class="hidden md:inline text-gray-300">|</span>
                  
                  <div *ngIf="order.account_name" class="flex items-center gap-1.5 font-medium text-gray-700">
                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                    </svg>
                    {{ order.account_name }}
                  </div>
                </div>
              </div>

              <!-- Right: Payment & Total -->
              <div class="flex items-center justify-between md:justify-end gap-6 border-t md:border-t-0 pt-4 md:pt-0 mt-2 md:mt-0 border-gray-100">
                <div class="text-right">
                  <div class="flex flex-col items-end">
                    <p class="text-xs text-gray-500 uppercase tracking-wide font-semibold mb-0.5">Total</p>
                    <p class="text-lg font-bold text-gray-900">{{ formatCurrency(order.amount) }}</p>
                    <p class="text-xs text-gray-500 mt-0.5 flex items-center gap-1">
                      <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
                      </svg>
                      {{ getPaymentMethodLabel(order.payment_method) }}
                    </p>
                  </div>
                </div>
                
                <div class="flex items-center gap-2">
                   <button (click)="openDetailsModal(order)" 
                          class="text-sm font-medium text-primary hover:text-primary-dark underline decoration-1 underline-offset-2 px-2 py-1 rounded hover:bg-gray-50 transition-colors">
                    Ver Detalhes
                  </button>
                </div>
              </div>
            </div>

            <!-- Alerts -->
            <div *ngIf="order.status === 'cancelled_by_customer' || order.status === 'cancelled_by_company' || order.status === 'rejected'" 
                 class="mt-3 pt-3 border-t border-gray-100">
              <div class="flex items-start gap-2 text-sm">
                <svg class="w-5 h-5 text-red-500 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <div>
                   <span class="font-medium text-red-700 block">
                    {{ order.status === 'rejected' ? 'Pedido Rejeitado' : 'Pedido Cancelado' }}
                   </span>
                   <span class="text-gray-600">
                     Motivo: {{ order.rejection_reason || order.cancellation_reason || order.cancellation_request_reason || 'Não informado' }}
                   </span>
                </div>
              </div>
            </div>
            
             <!-- Active Cancellation Request -->
             <div *ngIf="order.cancellation_requested_by_customer && order.status !== 'cancelled_by_customer'" 
                 class="mt-3 pt-3 border-t border-gray-100">
              <div class="flex items-start gap-2 text-sm">
                 <svg class="w-5 h-5 text-blue-500 mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <div>
                  <span class="font-medium text-blue-700 block">Solicitação de Cancelamento Pendente</span>
                  <span class="text-gray-600">Motivo: {{ order.cancellation_request_reason }}</span>
                </div>
              </div>
            </div>

          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Order Details Modal -->
<div *ngIf="showDetailsModal && selectedOrder" 
     class="fixed inset-0 z-50 overflow-y-auto" 
     aria-labelledby="details-modal-title" 
     role="dialog" 
     aria-modal="true">
  <div class="flex items-center justify-center min-h-screen px-4 pt-4 pb-20 text-center sm:block sm:p-0">
    <!-- Backdrop -->
    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" 
         aria-hidden="true" 
         (click)="closeDetailsModal()"></div>

    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

    <!-- Modal Panel -->
    <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-2xl w-full">
      
      <!-- Modal Header -->
      <div class="bg-white px-4 pt-5 pb-4 sm:p-6 border-b border-gray-100">
        <div class="flex items-center justify-between">
          <div>
            <h3 class="text-lg leading-6 font-medium text-gray-900" id="details-modal-title">
              Detalhes do Pedido {{ getOrderDisplayNumber(selectedOrder) }}
            </h3>
            <p class="mt-1 text-sm text-gray-500">
              <span class="flex items-center gap-1">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                Solicitado em: <strong>{{ formatDateTime(selectedOrder.created_at) || formatDateTime(selectedOrder.delivery_date) }}</strong>
              </span>
            </p>
          </div>
          <button (click)="closeDetailsModal()" class="text-gray-400 hover:text-gray-500 focus:outline-none">
            <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
            </svg>
          </button>
        </div>
      </div>

      <!-- Modal Body -->
      <div class="bg-gray-50 px-4 py-5 sm:p-6 max-h-[70vh] overflow-y-auto">
        
        <!-- Timeline (Only show if not cancelled/rejected) -->
        <div *ngIf="selectedOrder.status !== 'cancelled_by_customer' && selectedOrder.status !== 'cancelled_by_company' && selectedOrder.status !== 'rejected' && selectedOrder.status !== 'failed'" 
             class="mb-8 overflow-x-auto pb-2 bg-white p-4 rounded-lg shadow-sm border border-gray-100">
            <div class="min-w-[600px] flex items-center justify-between relative px-2">
              <!-- Line -->
              <div class="absolute left-0 top-1/2 transform -translate-y-1/2 w-full h-1 bg-gray-200 -z-10"></div>
              
              <!-- Steps -->
              <div *ngFor="let step of ['pending', 'notified', 'confirmed', 'in_transit', 'delivered']" class="flex flex-col items-center gap-2 relative z-0 bg-white px-2">
                <div class="w-8 h-8 rounded-full flex items-center justify-center transition-colors duration-300"
                     [ngClass]="getStatusTimeline(selectedOrder.status).includes(step) ? 'bg-primary text-white' : 'bg-gray-200 text-gray-400'">
                   <svg *ngIf="step === 'pending'" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                  <svg *ngIf="step === 'notified'" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9" /></svg>
                  <svg *ngIf="step === 'confirmed'" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                  <svg *ngIf="step === 'in_transit'" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg>
                  <svg *ngIf="step === 'delivered'" class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>
                </div>
                <span class="text-xs font-medium" [ngClass]="getStatusTimeline(selectedOrder.status).includes(step) ? 'text-primary' : 'text-gray-400'">
                  {{ getStatusLabel(step) }}
                </span>
              </div>
            </div>
        </div>

        <!-- Items List -->
        <div class="space-y-4 mb-8">
          <h4 class="text-sm font-semibold text-gray-500 uppercase tracking-wider">Itens do Pedido</h4>
          <div class="bg-white shadow overflow-hidden rounded-md">
            <ul class="divide-y divide-gray-200">
              <li *ngFor="let item of selectedOrder.items" class="px-6 py-4 flex items-start">
                <!-- Product Image (if available) -->
                <div class="flex-shrink-0 h-16 w-16 rounded-md border border-gray-200 overflow-hidden bg-gray-100 mr-4">
                   <img *ngIf="item.imageUrl" [src]="item.imageUrl" alt="{{item.productName}}" class="h-full w-full object-cover">
                   <div *ngIf="!item.imageUrl" class="h-full w-full flex items-center justify-center text-gray-400">
                     <svg class="h-8 w-8" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                       <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                     </svg>
                   </div>
                </div>
                <div class="flex-1 min-w-0">
                  <p class="text-sm font-medium text-gray-900 truncate">{{ item.productName }}</p>
                  <p class="text-sm text-gray-500 mt-1">{{ item.quantity }} x {{ formatCurrencyFromCents(item.priceCents) }}</p>
                  <!-- Added line-clamp for description -->
                  <p *ngIf="item.description" class="text-xs text-gray-400 mt-1 line-clamp-2" title="{{ item.description }}">{{ item.description }}</p>
                </div>
                <div class="ml-4 text-sm font-semibold text-gray-900 whitespace-nowrap">
                  {{ formatCurrencyFromCents(item.quantity * item.priceCents) }}
                </div>
              </li>
              <!-- Price Breakdown -->
              <li class="px-6 py-4 bg-gray-50 border-t border-gray-200 space-y-2">
                <div class="flex justify-between items-center">
                  <span class="text-sm text-gray-600">Subtotal</span>
                  <span class="text-sm font-medium text-gray-900">{{ formatCurrencyFromCents(selectedOrder.subtotal_cents || (selectedOrder.amount * 100)) }}</span>
                </div>
                <div *ngIf="selectedOrder.club_discount_cents && selectedOrder.club_discount_cents > 0" class="flex justify-between items-center">
                  <span class="text-sm text-gray-600">Desconto Clube VIP</span>
                  <span class="text-sm font-medium text-success">-{{ formatCurrencyFromCents(selectedOrder.club_discount_cents) }}</span>
                </div>
                <div *ngIf="selectedOrder.promotion_discount_cents && selectedOrder.promotion_discount_cents > 0" class="flex justify-between items-center">
                  <span class="text-sm text-gray-600">Desconto Cupom {{ selectedOrder.promotion_code }}</span>
                  <span class="text-sm font-medium text-success">-{{ formatCurrencyFromCents(selectedOrder.promotion_discount_cents) }}</span>
                </div>
                <div class="flex justify-between items-center pt-2 border-t border-gray-200">
                  <span class="text-base font-medium text-gray-900">Total do Pedido</span>
                  <span class="text-lg font-bold text-primary">{{ formatCurrency(selectedOrder.amount) }}</span>
                </div>
              </li>
            </ul>
          </div>
        </div>

        <!-- Delivery & Payment Info Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
            <!-- Delivery Info -->
            <div>
              <h4 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-3">Entrega</h4>
              <div class="bg-white shadow rounded-lg p-4 space-y-3">
                <div class="flex items-start gap-3">
                  <svg class="w-5 h-5 text-gray-400 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                  </svg>
                  <div>
                    <p class="text-sm font-medium text-gray-900">Endereço</p>
                    <p class="text-sm text-gray-600">{{ selectedOrder.delivery_address }}</p>
                  </div>
                </div>
                <div class="flex items-start gap-3 border-t border-gray-100 pt-2">
                   <svg class="w-5 h-5 text-gray-400 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                  </svg>
                  <div>
                    <p class="text-sm font-medium text-gray-900">Data e Horário Previstos</p>
                    <p class="text-sm text-gray-600">{{ formatDateTime(selectedOrder.delivery_date) }}</p>
                  </div>
                </div>
                 <div *ngIf="selectedOrder.actual_delivery_date" class="flex items-start gap-3 border-t border-gray-100 pt-2">
                   <svg class="w-5 h-5 text-green-500 mt-0.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                  </svg>
                  <div>
                    <p class="text-sm font-medium text-gray-900">Entregue em</p>
                    <p class="text-sm text-gray-600">{{ formatDateTime(selectedOrder.actual_delivery_date) }}</p>
                  </div>
                </div>
              </div>
            </div>

            <!-- Payment Info -->
            <div>
              <h4 class="text-sm font-semibold text-gray-500 uppercase tracking-wider mb-3">Pagamento</h4>
              <div class="bg-white shadow rounded-lg p-4 space-y-3">
                <div class="flex items-center justify-between">
                  <span class="text-sm text-gray-600">Status</span>
                  <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium capitalize"
                        [ngClass]="{
                          'bg-green-100 text-green-800': selectedOrder.payment_status === 'paid',
                          'bg-yellow-100 text-yellow-800': selectedOrder.payment_status === 'pending' || selectedOrder.payment_status === 'partial',
                          'bg-red-100 text-red-800': selectedOrder.payment_status === 'failed' || selectedOrder.payment_status === 'refunded',
                          'bg-gray-100 text-gray-800': selectedOrder.payment_status === 'unpaid'
                        }">
                    {{ getPaymentStatusLabel(selectedOrder.payment_status) }}
                  </span>
                </div>
                <div class="flex items-center justify-between border-t border-gray-100 pt-2">
                  <span class="text-sm text-gray-600">Método</span>
                  <span class="text-sm font-medium text-gray-900 flex items-center gap-1.5">
                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" />
                    </svg>
                    {{ getPaymentMethodLabel(selectedOrder.payment_method) }}
                  </span>
                </div>
              </div>
            </div>
        </div>
      </div>

      <!-- Modal Footer -->
      <div class="bg-gray-50 px-4 py-3 sm:px-6 flex flex-col sm:flex-row-reverse gap-3 sm:gap-0 border-t border-gray-200">
        <button type="button" 
                (click)="closeDetailsModal()"
                class="w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary sm:ml-3 sm:w-auto sm:text-sm">
          Fechar
        </button>

        <button *ngIf="canRequestCancellation(selectedOrder)" 
                (click)="openCancellationRequestModal(selectedOrder)"
                class="w-full inline-flex justify-center rounded-md border border-red-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-red-700 hover:bg-red-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:w-auto sm:text-sm">
          Solicitar Cancelamento
        </button>
        
        <button *ngIf="selectedOrder.status === 'delivered'" 
                (click)="reorder(selectedOrder)"
                class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-primary text-base font-medium text-white hover:bg-primary-dark focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary sm:w-auto sm:text-sm sm:mr-3">
          Comprar Novamente
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Request Cancellation Modal -->
<div *ngIf="showCancellationRequestModal" 
     class="fixed inset-0 z-50 overflow-y-auto" 
     aria-labelledby="modal-title" 
     role="dialog" 
     aria-modal="true">
  <div class="flex items-end justify-center min-h-screen pt-4 px-4 pb-20 text-center sm:block sm:p-0">
    <!-- Backdrop -->
    <div class="fixed inset-0 bg-gray-500 bg-opacity-75 transition-opacity" 
         aria-hidden="true" 
         (click)="showCancellationRequestModal = false"></div>

    <!-- Spacer -->
    <span class="hidden sm:inline-block sm:align-middle sm:h-screen" aria-hidden="true">&#8203;</span>

    <!-- Modal Panel -->
    <div class="inline-block align-bottom bg-white rounded-lg text-left overflow-hidden shadow-xl transform transition-all sm:my-8 sm:align-middle sm:max-w-lg w-full">
      <div class="bg-white px-4 pt-5 pb-4 sm:p-6 sm:pb-4">
        <div class="sm:flex sm:items-start">
          <div class="mx-auto flex-shrink-0 flex items-center justify-center h-12 w-12 rounded-full bg-red-100 sm:mx-0 sm:h-10 sm:w-10">
            <svg class="h-6 w-6 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
            </svg>
          </div>
          <div class="mt-3 text-center sm:mt-0 sm:ml-4 sm:text-left w-full">
            <h3 class="text-lg leading-6 font-medium text-gray-900" id="modal-title">
              Solicitar Cancelamento
            </h3>
            <div class="mt-2">
              <p class="text-sm text-gray-500">
                Você está solicitando o cancelamento do pedido <strong>{{ selectedOrder?.order_number }}</strong>.
                Por favor, nos informe o motivo abaixo. A empresa analisará sua solicitação.
              </p>
              
              <div class="mt-4">
                <textarea
                  [(ngModel)]="cancellationRequestReason"
                  rows="4"
                  class="shadow-sm focus:ring-primary focus:border-primary block w-full sm:text-sm border-gray-300 rounded-md p-2 border"
                  placeholder="Descreva o motivo do cancelamento (mínimo 10 caracteres)"></textarea>
                <p class="mt-1 text-xs text-gray-500 text-right">
                  {{ cancellationRequestReason.length }} caracteres
                </p>
              </div>
            </div>
          </div>
        </div>
      </div>
      <div class="bg-gray-50 px-4 py-3 sm:px-6 sm:flex sm:flex-row-reverse">
        <button type="button" 
                [disabled]="cancellationRequestReason.length < 10 || loadingCancellation"
                (click)="requestCancellation()"
                class="w-full inline-flex justify-center rounded-md border border-transparent shadow-sm px-4 py-2 bg-red-600 text-base font-medium text-white hover:bg-red-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-red-500 sm:ml-3 sm:w-auto sm:text-sm disabled:opacity-50 disabled:cursor-not-allowed">
          <svg *ngIf="loadingCancellation" class="animate-spin -ml-1 mr-2 h-4 w-4 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
            <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
            <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
          </svg>
          {{ loadingCancellation ? 'Enviando...' : 'Enviar Solicitação' }}
        </button>
        <button type="button" 
                (click)="showCancellationRequestModal = false"
                class="mt-3 w-full inline-flex justify-center rounded-md border border-gray-300 shadow-sm px-4 py-2 bg-white text-base font-medium text-gray-700 hover:bg-gray-50 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-primary sm:mt-0 sm:ml-3 sm:w-auto sm:text-sm">
          Cancelar
        </button>
      </div>
    </div>
  </div>
</div>
