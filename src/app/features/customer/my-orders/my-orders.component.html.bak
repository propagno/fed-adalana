<div class="min-h-screen bg-background">
  <!-- Marketplace Navbar -->
  <app-marketplace-navbar></app-marketplace-navbar>
  
  <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <!-- Header -->
    <div class="mb-8">
      <h1 class="text-h1 font-display text-primary">Meus Pedidos</h1>
      <p class="text-body-lg text-gray-600 mt-2">Acompanhe o histórico e status das suas entregas</p>
    </div>

    <!-- Loading State -->
    <div *ngIf="loading" class="space-y-6">
      <app-skeleton-loader *ngFor="let i of [1,2,3]" type="card"></app-skeleton-loader>
    </div>

    <!-- Empty State -->
    <app-empty-state *ngIf="!loading && orders.length === 0"
                     title="Nenhum Pedido"
                     message="Você ainda não possui pedidos. Quando você fizer um pedido, ele aparecerá aqui."
                     [actionLabel]="'Explorar Catálogo'"
                     [actionHandler]="goToCatalog.bind(this)">
    </app-empty-state>

    <!-- Orders Timeline -->
    <div *ngIf="!loading && orders.length > 0" class="space-y-6">
      <app-card *ngFor="let order of orders; let i = index" 
                variant="interactive"
                [elevation]="1"
                padding="lg"
                customClass="relative">
        <!-- Timeline Line -->
        <div *ngIf="i < orders.length - 1" 
             class="absolute left-8 top-20 bottom-0 w-0.5 bg-gray-200"></div>

        <!-- Order Header -->
        <div class="flex items-start gap-4 mb-6">
          <!-- Timeline Dot -->
          <div class="relative flex-shrink-0">
            <div [class]="getTimelineDotClass(order.status)" 
                 class="w-8 h-8 rounded-full flex items-center justify-center border-2 border-white shadow-elevation-1">
              <app-map-pin-icon 
                *ngIf="order.status === 'delivered'"
                size="sm" 
                variant="filled" 
                color="text-white">
              </app-map-pin-icon>
              <div *ngIf="order.status !== 'delivered'" 
                   [class]="getTimelineDotInnerClass(order.status)"
                   class="w-3 h-3 rounded-full">
              </div>
            </div>
          </div>

          <!-- Order Info -->
          <div class="flex-1">
            <div class="flex items-start justify-between mb-2">
              <div>
                <h3 class="text-h3 font-display text-primary mb-1">
                  {{ order.product_name || 'Produto' }}
                </h3>
                <div class="flex items-center gap-3 mb-1">
                  <p class="text-body-sm text-gray-500">
                    Pedido {{ order.order_number || (order.id ? '#' + order.id.substring(0, 8) : 'N/A') }}
                  </p>
                </div>
                <p *ngIf="order.account_name" class="text-body-sm text-gray-600 font-medium flex items-center gap-2">
                  <svg class="w-4 h-4 text-primary-light" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 21V5a2 2 0 00-2-2H7a2 2 0 00-2 2v16m14 0h2m-2 0h-5m-9 0H3m2 0h5M9 7h1m-1 4h1m4-4h1m-1 4h1m-5 10v-5a1 1 0 011-1h2a1 1 0 011 1v5m-4 0h4" />
                  </svg>
                  {{ order.account_name }}
                </p>
              </div>
              <app-badge 
                [variant]="getStatusBadgeVariant(order.status)"
                size="md"
                [label]="getStatusLabel(order.status)">
              </app-badge>
            </div>
          </div>
        </div>

        <!-- Company Acceptance Status -->
        <div *ngIf="order.account_name" 
             class="mb-6"
             [ngClass]="getAcceptanceStatusBorderClass(order.acceptance_status)">
          <app-card variant="highlighted" 
                   [elevation]="0" 
                   padding="md">
            <div class="flex items-center gap-3">
              <div class="w-10 h-10 rounded-large flex items-center justify-center flex-shrink-0"
                 [class.bg-success/10]="order.acceptance_status === 'accepted'"
                 [class.bg-warning/10]="order.acceptance_status === 'pending'"
                 [class.bg-error/10]="isRejectedOrCancelled(order.acceptance_status)">
                <svg *ngIf="order.acceptance_status === 'accepted'" class="w-5 h-5 text-success" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
                </svg>
                <svg *ngIf="order.acceptance_status === 'pending'" class="w-5 h-5 text-warning" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <svg *ngIf="isRejectedOrCancelled(order.acceptance_status)" class="w-5 h-5 text-error" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
                </svg>
              </div>
              <div class="flex-1">
                <p class="text-body-sm font-medium text-primary mb-1">Status da Empresa</p>
                <p class="text-body text-gray-900">
                  <span *ngIf="order.acceptance_status === 'accepted'">✓ Pedido aceito pela empresa</span>
                  <span *ngIf="order.acceptance_status === 'pending'">⏳ Aguardando confirmação da empresa</span>
                  <span *ngIf="order.acceptance_status === 'rejected'">✗ Pedido rejeitado pela empresa</span>
                  <span *ngIf="order.acceptance_status === 'cancelled_by_company'">✗ Pedido cancelado pela empresa</span>
                  <span *ngIf="order.status === 'delivered'">✓ Pedido entregue</span>
                  <span *ngIf="!order.acceptance_status && order.status === 'pending'">⏳ Aguardando confirmação</span>
                </p>
              </div>
            </div>
          </app-card>
        </div>

        <!-- Order Details Grid -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
          <div class="p-4 bg-gray-50 rounded-large">
            <p class="text-body-sm text-gray-600 mb-1">Quantidade</p>
            <p class="text-h4 font-semibold text-primary">{{ order.quantity || '-' }}</p>
          </div>
          <div class="p-4 bg-gray-50 rounded-large">
            <p class="text-body-sm text-gray-600 mb-1">Data de Entrega</p>
            <p class="text-h4 font-semibold text-primary">{{ formatDate(order.delivery_date) }}</p>
          </div>
          <div class="p-4 bg-gray-50 rounded-large">
            <p class="text-body-sm text-gray-600 mb-1">Valor</p>
            <p class="text-h4 font-semibold text-primary-light">{{ formatCurrency(order.amount) }}</p>
          </div>
          <div class="p-4 bg-gray-50 rounded-large">
            <p class="text-body-sm text-gray-600 mb-1">Pagamento</p>
            <p class="text-body font-semibold text-primary">{{ getPaymentStatusLabel(order.payment_status) }}</p>
          </div>
        </div>

        <!-- Delivery Address com Pin de Mapa -->
        <div *ngIf="order.delivery_address" class="mb-6 border-l-4 border-primary-light">
          <app-card variant="highlighted" 
                   [elevation]="0" 
                   padding="md">
            <div class="flex items-start gap-3">
              <div class="w-10 h-10 bg-primary-light/10 rounded-large flex items-center justify-center flex-shrink-0">
                <app-map-pin-icon size="md" variant="filled" color="text-primary-light"></app-map-pin-icon>
              </div>
              <div class="flex-1">
                <p class="text-body-sm font-medium text-primary mb-1">Endereço de Entrega</p>
                <p class="text-body text-gray-900">{{ order.delivery_address }}</p>
              </div>
            </div>
          </app-card>
        </div>

        <!-- Status Timeline -->
        <div class="pt-4 border-t border-gray-200">
          <p class="text-body-sm font-medium text-primary mb-3">Status da Entrega</p>
          <div class="flex flex-wrap gap-2">
            <app-badge 
              *ngFor="let status of getStatusTimeline(order.status)"
              [variant]="getTimelineBadgeVariant(status, order.status)"
              size="sm"
              [label]="getStatusLabel(status)">
            </app-badge>
          </div>
        </div>

        <!-- Rejection/Cancellation Reasons -->
        <div *ngIf="order.rejection_reason || order.cancellation_reason" 
             class="mt-4 pt-4 border-t border-gray-200">
          <div [ngClass]="getRejectionCancellationBorderClass(order)">
            <app-card variant="highlighted" 
                     [elevation]="0" 
                     padding="md">
              <div class="flex items-start gap-3">
                <div class="flex-shrink-0 w-10 h-10 rounded-full flex items-center justify-center"
                   [class.bg-error/10]="order.rejection_reason"
                   [class.bg-warning/10]="order.cancellation_reason">
                  <svg class="w-5 h-5" 
                       [class.text-error]="order.rejection_reason" 
                       [class.text-warning]="order.cancellation_reason"
                       fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z" />
                  </svg>
                </div>
                <div class="flex-1 min-w-0">
                  <p class="text-body-sm font-medium text-primary mb-1">
                    {{ order.rejection_reason ? 'Motivo da Rejeição' : 'Motivo do Cancelamento' }}
                  </p>
                  <p class="text-body-sm text-gray-600 break-words">
                    {{ order.rejection_reason || order.cancellation_reason }}
                  </p>
                </div>
              </div>
            </app-card>
          </div>
        </div>

        <!-- Cancellation Request Status -->
        <div *ngIf="order.cancellation_requested_by_customer" 
             class="mt-4 pt-4 border-t border-gray-200">
          <div class="border-l-4 border-info">
            <app-card variant="highlighted" 
                     [elevation]="0" 
                     padding="md">
            <div class="flex items-start gap-3">
              <div class="flex-shrink-0 w-10 h-10 rounded-full bg-info/10 flex items-center justify-center">
                <svg class="w-5 h-5 text-info" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
              </div>
              <div class="flex-1 min-w-0">
                <p class="text-body-sm font-medium text-primary mb-1">
                  Solicitação de Cancelamento
                </p>
                <p class="text-body-sm text-gray-600 mb-2">
                  Status: <strong>{{ getCancellationRequestStatusLabel(order.cancellation_request_status) }}</strong>
                </p>
                <p *ngIf="order.cancellation_request_reason" class="text-body-sm text-gray-500 mb-2 break-words">
                  Seu motivo: {{ order.cancellation_request_reason }}
                </p>
                <p *ngIf="order.cancellation_request_status === 'rejected' && order.rejection_reason" 
                   class="text-body-sm text-error mt-2 break-words">
                  Motivo da rejeição pela empresa: {{ order.rejection_reason }}
                </p>
              </div>
            </div>
            </app-card>
          </div>
        </div>

        <!-- Request Cancellation Button -->
        <div *ngIf="canRequestCancellation(order)" 
             class="mt-4 pt-4 border-t border-gray-200">
          <app-button 
            variant="outline"
            size="md"
            label="Solicitar Cancelamento"
            (clicked)="openCancellationRequestModal(order)"
            [fullWidth]="true">
          </app-button>
        </div>

        <!-- Actions -->
        <div *ngIf="order.status === 'delivered'" class="pt-4 border-t border-gray-200 mt-4">
          <app-button 
            variant="secondary"
            size="md"
            label="Reordenar"
            (clicked)="reorder(order)"
            [fullWidth]="true">
          </app-button>
        </div>
      </app-card>
    </div>
  </div>
</div>

<!-- Request Cancellation Modal (Mobile-First: Bottom Sheet) -->
<div *ngIf="showCancellationRequestModal" 
     class="fixed inset-0 z-50 flex items-end md:items-center justify-center bg-black/50 p-0 md:p-4 animate-fade-in"
     (click)="showCancellationRequestModal = false"
     role="dialog"
     aria-modal="true"
     aria-labelledby="cancellation-modal-title">
  <div class="bg-white rounded-t-3xl md:rounded-large shadow-elevation-3 w-full md:max-w-md md:max-h-[90vh] overflow-y-auto animate-slide-up md:animate-scale-in"
       (click)="$event.stopPropagation()">
    <!-- Mobile Header -->
    <div class="sticky top-0 bg-white border-b border-gray-200 px-6 py-4 flex items-center justify-between md:hidden">
      <h2 id="cancellation-modal-title" class="text-h2 font-display text-primary">Solicitar Cancelamento</h2>
      <button 
        (click)="showCancellationRequestModal = false"
        aria-label="Fechar modal"
        class="text-gray-400 hover:text-gray-600 transition-colors p-2 -mr-2">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>
    </div>
    
    <div class="p-6">
      <!-- Desktop Header -->
      <h2 id="cancellation-modal-title-desktop" class="hidden md:block text-h2 font-display text-primary mb-4">Solicitar Cancelamento</h2>
      <p class="text-body text-gray-600 mb-6">
        Por favor, informe o motivo do cancelamento do pedido <strong>{{ selectedOrder?.order_number || (selectedOrder?.id ? '#' + selectedOrder.id.substring(0, 8) : 'N/A') }}</strong>:
      </p>
      <div class="mb-6">
        <label class="block text-body-sm font-medium text-gray-700 mb-2">
          Motivo do Cancelamento <span class="text-error">*</span>
        </label>
        <textarea
          [(ngModel)]="cancellationRequestReason"
          class="w-full p-3 border border-gray-300 rounded-medium focus:ring-2 focus:ring-primary focus:border-transparent min-h-[120px] text-body"
          placeholder="Descreva o motivo do cancelamento (mínimo 10 caracteres)"
          [maxlength]="500"
          rows="4"
          aria-describedby="char-count"
          aria-invalid="false">
        </textarea>
        <p id="char-count" class="text-body-xs text-gray-500 mt-1">
          {{ cancellationRequestReason.length }}/500 caracteres
          <span *ngIf="cancellationRequestReason.length < 10" class="text-warning ml-2">
            (mínimo 10 caracteres)
          </span>
        </p>
      </div>
      <div class="flex flex-col sm:flex-row gap-3">
        <app-button 
          variant="ghost"
          size="md"
          label="Cancelar"
          (clicked)="showCancellationRequestModal = false"
          [fullWidth]="true">
        </app-button>
        <app-button 
          variant="primary"
          size="md"
          label="Enviar Solicitação"
          (clicked)="requestCancellation()"
          [disabled]="cancellationRequestReason.length < 10"
          [loading]="loadingCancellation"
          [fullWidth]="true">
        </app-button>
      </div>
    </div>
  </div>
</div>

