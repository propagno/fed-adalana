<div class="min-h-screen bg-background">
  <app-marketplace-navbar></app-marketplace-navbar>
  
  <div class="container mx-auto px-4 sm:px-6 lg:px-8 py-8 max-w-4xl">
    <app-page-header
      title="Meu Perfil"
      description="Gerencie suas informações pessoais, endereços e segurança"
      [showActions]="false">
    </app-page-header>

    <!-- Tabs -->
    <div class="mb-6 border-b border-gray-200 overflow-x-auto">
      <nav class="flex space-x-8" aria-label="Tabs">
        <button
          (click)="onTabChange('personal')"
          [class.border-primary]="activeTab === 'personal'"
          [class.text-primary]="activeTab === 'personal'"
          [class.border-transparent]="activeTab !== 'personal'"
          [class.text-gray-500]="activeTab !== 'personal'"
          class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors hover:text-primary focus:outline-none">
          Dados Pessoais
        </button>
        <button
          (click)="onTabChange('addresses')"
          [class.border-primary]="activeTab === 'addresses'"
          [class.text-primary]="activeTab === 'addresses'"
          [class.border-transparent]="activeTab !== 'addresses'"
          [class.text-gray-500]="activeTab !== 'addresses'"
          class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors hover:text-primary focus:outline-none">
          Endereços
        </button>
        <button
          (click)="onTabChange('security')"
          [class.border-primary]="activeTab === 'security'"
          [class.text-primary]="activeTab === 'security'"
          [class.border-transparent]="activeTab !== 'security'"
          [class.text-gray-500]="activeTab !== 'security'"
          class="whitespace-nowrap py-4 px-1 border-b-2 font-medium text-sm transition-colors hover:text-primary focus:outline-none">
          Segurança
        </button>
      </nav>
    </div>

    <!-- Personal Data Tab -->
    <div *ngIf="activeTab === 'personal'" class="space-y-6 animate-fade-in">
      <app-card variant="default" [elevation]="1" padding="lg">
        <form [formGroup]="personalForm" (ngSubmit)="onPersonalSubmit()" class="space-y-4">
          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <app-input
              formControlName="name"
              label="Nome completo"
              placeholder="Digite seu nome completo"
              [required]="true"
              [errorMessage]="personalForm.get('name')?.hasError('required') ? 'Nome é obrigatório' : 
                             personalForm.get('name')?.hasError('minlength') ? 'Nome deve ter pelo menos 3 caracteres' : ''">
            </app-input>

            <app-input
              formControlName="email"
              type="email"
              label="Email"
              placeholder="seu@email.com"
              [required]="true"
              [errorMessage]="personalForm.get('email')?.hasError('required') ? 'Email é obrigatório' : 
                             personalForm.get('email')?.hasError('email') ? 'Email inválido' : ''">
            </app-input>

            <app-input
              formControlName="phone"
              type="tel"
              label="Telefone"
              placeholder="(11) 99999-9999"
              (input)="onPhoneInput($event)"
              [required]="true"
              [errorMessage]="personalForm.get('phone')?.hasError('required') ? 'Telefone é obrigatório' : ''">
            </app-input>

            <app-input
              formControlName="cpf"
              label="CPF"
              placeholder="000.000.000-00"
              (input)="onCPFInput($event)"
              [maxLength]="14"
              helperText="Opcional">
            </app-input>
          </div>

          <div class="flex justify-end pt-4">
            <app-button
              type="submit"
              variant="primary"
              [loading]="personalLoading"
              [disabled]="personalForm.invalid || personalLoading"
              label="Salvar Alterações">
            </app-button>
          </div>

          <div *ngIf="personalError" class="mt-4 p-3 bg-error/10 border border-error/20 rounded-medium text-error text-body-sm">
            {{ personalError }}
          </div>
        </form>
      </app-card>
    </div>

    <!-- Addresses Tab -->
    <div *ngIf="activeTab === 'addresses'" class="space-y-6 animate-fade-in">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-h4 text-primary">Meus Endereços</h3>
        <app-button 
          variant="primary" 
          size="sm" 
          label="+ Adicionar Endereço" 
          (clicked)="openAddressModal()">
        </app-button>
      </div>

      <div *ngIf="addressesLoading" class="text-center py-8">
        <app-skeleton-loader type="card"></app-skeleton-loader>
      </div>

      <div *ngIf="!addressesLoading && addresses.length === 0" class="text-center py-12 bg-gray-50 rounded-large border border-dashed border-gray-300">
        <app-map-pin-icon size="xl" variant="outline" color="text-gray-400" class="mx-auto mb-4"></app-map-pin-icon>
        <p class="text-gray-600 mb-4">Você ainda não possui endereços cadastrados</p>
        <app-button variant="outline" label="Adicionar primeiro endereço" (clicked)="openAddressModal()">
        </app-button>
      </div>

      <div *ngIf="!addressesLoading && addresses.length > 0" class="grid gap-4 md:grid-cols-2">
        <app-card *ngFor="let address of addresses" variant="default" [elevation]="1" padding="md" customClass="h-full flex flex-col">
          <div class="flex justify-between items-start mb-3 flex-1">
            <div>
              <div class="flex items-center gap-2 mb-1">
                <h4 class="text-body-lg font-semibold text-primary">{{ address.label }}</h4>
                <app-badge *ngIf="address.is_default" variant="info" size="sm" label="Padrão"></app-badge>
              </div>
              <p class="text-body-sm text-gray-600">{{ address.address }}</p>
            </div>
          </div>
          <div class="flex gap-2 mt-4 pt-4 border-t border-gray-100">
            <app-button
              variant="outline"
              size="sm"
              label="Editar"
              [fullWidth]="true"
              (clicked)="openAddressModal(address)">
            </app-button>
            <app-button
              *ngIf="!address.is_default"
              variant="ghost"
              size="sm"
              label="Definir Padrão"
              [fullWidth]="true"
              (clicked)="setDefaultAddress(address)">
            </app-button>
            <app-button
              variant="danger"
              size="sm"
              label="Remover"
              [fullWidth]="true"
              (clicked)="deleteAddress(address)">
            </app-button>
          </div>
        </app-card>
      </div>

      <!-- Address Modal -->
      <app-modal
        [isOpen]="showAddressModal"
        [title]="editingAddress ? 'Editar Endereço' : 'Novo Endereço'"
        [confirmLabel]="'Salvar Endereço'"
        cancelLabel="Cancelar"
        [loading]="addressFormLoading"
        (confirmed)="onAddressSubmit()"
        (cancelled)="closeAddressModal()"
        (closed)="closeAddressModal()">
        
        <form [formGroup]="addressForm" (ngSubmit)="onAddressSubmit()" class="space-y-4">
          <app-input
            formControlName="label"
            label="Rótulo (ex: Casa, Trabalho)"
            placeholder="Identifique este endereço"
            [required]="true"
            [errorMessage]="addressForm.get('label')?.hasError('required') ? 'Rótulo é obrigatório' : ''">
          </app-input>

          <!-- CEP -->
          <div>
            <app-input
              formControlName="cep"
              label="CEP"
              placeholder="00000-000"
              maxlength="9"
              appCepLookup
              [addressControl]="addressForm.get('address')"
              [cityControl]="addressForm.get('city')"
              [stateControl]="addressForm.get('state')"
              [neighborhoodControl]="addressForm.get('neighborhood')"
              (cepFound)="onCepFound($event)"
              (cepError)="onCepError($event)"
              (input)="onCepInput($event)"
              [required]="true"
              [errorMessage]="addressForm.get('cep')?.hasError('required') ? 'CEP é obrigatório' : (addressForm.get('cep')?.hasError('pattern') ? 'CEP inválido' : '')">
            </app-input>
            <p *ngIf="loadingCep" class="mt-1 text-xs text-blue-600">Buscando endereço...</p>
          </div>

          <!-- Endereço (Rua/Logradouro) -->
          <app-input
            formControlName="address"
            label="Endereço (Rua/Logradouro)"
            placeholder="Rua, Avenida, etc."
            [required]="true"
            [errorMessage]="addressForm.get('address')?.hasError('required') ? 'Endereço é obrigatório' : ''">
          </app-input>

          <!-- Número e Complemento -->
          <div class="grid grid-cols-2 gap-4">
            <app-input
              formControlName="number"
              label="Número"
              placeholder="123"
              [required]="true"
              [errorMessage]="addressForm.get('number')?.hasError('required') ? 'Número é obrigatório' : ''">
            </app-input>
            <app-input
              formControlName="complement"
              label="Complemento"
              placeholder="Apto, Bloco, etc. (opcional)">
            </app-input>
          </div>

          <!-- Bairro -->
          <app-input
            formControlName="neighborhood"
            label="Bairro"
            placeholder="Nome do bairro"
            [required]="true"
            [errorMessage]="addressForm.get('neighborhood')?.hasError('required') ? 'Bairro é obrigatório' : ''">
          </app-input>

          <!-- Cidade e Estado -->
          <div class="grid grid-cols-2 gap-4">
            <app-input
              formControlName="city"
              label="Cidade"
              placeholder="Cidade"
              [required]="true"
              [errorMessage]="addressForm.get('city')?.hasError('required') ? 'Cidade é obrigatória' : ''">
            </app-input>
            <app-input
              formControlName="state"
              label="Estado (UF)"
              placeholder="SP"
              maxlength="2"
              [required]="true"
              [errorMessage]="addressForm.get('state')?.hasError('required') ? 'Estado é obrigatório' : ''">
            </app-input>
          </div>

          <div class="flex items-center mt-2">
            <input
              type="checkbox"
              id="is_default"
              formControlName="is_default"
              class="w-4 h-4 text-primary border-gray-300 rounded focus:ring-primary">
            <label for="is_default" class="ml-2 text-body-sm text-gray-700 cursor-pointer">
              Definir como endereço padrão
            </label>
          </div>
        </form>
      </app-modal>
    </div>

    <!-- Security Tab -->
    <div *ngIf="activeTab === 'security'" class="space-y-6 animate-fade-in">
      <app-card variant="default" [elevation]="1" padding="lg">
        <h3 class="text-h4 text-primary mb-4">Alterar Senha</h3>
        
        <form [formGroup]="securityForm" (ngSubmit)="onSecuritySubmit()" class="space-y-4">
          <app-input
            formControlName="currentPassword"
            type="password"
            label="Senha atual"
            placeholder="Digite sua senha atual"
            [required]="true"
            [errorMessage]="securityForm.get('currentPassword')?.hasError('required') ? 'Senha atual é obrigatória' : ''">
          </app-input>

          <app-input
            formControlName="newPassword"
            type="password"
            label="Nova senha"
            placeholder="Mínimo 8 caracteres"
            [required]="true"
            (input)="onPasswordInput()"
            [errorMessage]="securityForm.get('newPassword')?.hasError('required') ? 'Nova senha é obrigatória' : 
                           securityForm.get('newPassword')?.hasError('minlength') ? 'Senha deve ter pelo menos 8 caracteres' : ''">
          </app-input>

          <!-- Password Strength Indicator -->
          <div *ngIf="securityForm.get('newPassword')?.value" class="space-y-2">
            <div class="flex items-center gap-2">
              <div class="flex-1 h-2 bg-gray-200 rounded-full overflow-hidden">
                <div 
                  [class]="getPasswordStrengthColor()"
                  [style.width.%]="(passwordStrength / 5) * 100"
                  class="h-full transition-all duration-300">
                </div>
              </div>
              <span class="text-body-sm text-gray-600">{{ getPasswordStrengthLabel() }}</span>
            </div>
          </div>

          <app-input
            formControlName="confirmPassword"
            type="password"
            label="Confirmar nova senha"
            placeholder="Digite a nova senha novamente"
            [required]="true"
            [errorMessage]="securityForm.get('confirmPassword')?.hasError('required') ? 'Confirmação é obrigatória' : 
                           securityForm.get('confirmPassword')?.hasError('passwordMismatch') ? 'As senhas não coincidem' : ''">
          </app-input>

          <div class="flex justify-end pt-4">
            <app-button
              type="submit"
              variant="primary"
              [loading]="securityLoading"
              [disabled]="securityForm.invalid || securityLoading"
              label="Alterar Senha">
            </app-button>
          </div>

          <div *ngIf="securityError" class="mt-4 p-3 bg-error/10 border border-error/20 rounded-medium text-error text-body-sm">
            {{ securityError }}
          </div>
        </form>
      </app-card>
    </div>
  </div>
</div>

