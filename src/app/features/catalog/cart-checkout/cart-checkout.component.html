<div class="min-h-screen bg-background">
  <app-marketplace-navbar></app-marketplace-navbar>
  
  <div class="w-full max-w-4xl mx-auto px-4 py-12">
    <!-- Progress Indicator -->
    <div class="mb-8">
      <app-progress-indicator 
        [steps]="progressSteps"
        [currentStep]="'checkout'">
      </app-progress-indicator>
    </div>
    
    <!-- Header -->
    <app-page-header
      title="Finalizar Pedido"
      description="Confirme seus dados e finalize o pedido"
      [showActions]="false">
    </app-page-header>

    <!-- Loading State -->
    <div *ngIf="loading" class="py-12 text-center">
      <app-skeleton-loader type="card"></app-skeleton-loader>
    </div>

    <!-- Error Message -->
    <div *ngIf="error" class="mb-6 p-4 bg-error/10 border-l-4 border-error rounded-r-lg flex items-center gap-2">
      <svg class="w-5 h-5 text-error flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
      </svg>
      <p class="text-body-sm text-error font-medium">{{ error }}</p>
    </div>

    <!-- Success Message -->
    <div *ngIf="successMessage" class="mb-6 p-4 bg-success/10 border-l-4 border-success rounded-r-lg">
      <div class="flex items-center gap-2 mb-2">
        <svg class="w-5 h-5 text-success flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" />
        </svg>
        <p class="text-body-sm text-success font-medium">{{ successMessage }}</p>
      </div>
      <div *ngIf="orderNumber" class="ml-7">
        <p class="text-body-sm text-gray-700">
          <span class="font-semibold">N√∫mero do Pedido:</span>
          <span class="font-mono text-primary ml-2">{{ orderNumber }}</span>
        </p>
        <p class="text-body-xs text-gray-600 mt-1">Guarde este n√∫mero para refer√™ncia em caso de d√∫vidas ou problemas.</p>
      </div>
    </div>

    <div *ngIf="!loading && cart && company" class="grid grid-cols-1 lg:grid-cols-3 gap-8">
      <!-- Form -->
      <div class="lg:col-span-2 space-y-6">
        <!-- Company Information Card -->
        <app-card variant="default" [elevation]="1" padding="md" customClass="bg-white">
          <div class="flex flex-col sm:flex-row items-start sm:items-center gap-4">
            <div class="flex-1">
              <h3 class="text-lg md:text-h3 font-semibold text-gray-900 mb-1">{{ company.company_name }}</h3>
              <p *ngIf="company.category" class="text-body-sm text-gray-600 mb-1">{{ company.category }}</p>
              <div *ngIf="company.phone" class="flex items-center gap-2 text-body-sm text-gray-600">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5a2 2 0 012-2h3.28a1 1 0 01.948.684l1.498 4.493a1 1 0 01-.502 1.21l-2.257 1.13a11.042 11.042 0 005.516 5.516l1.13-2.257a1 1 0 011.21-.502l4.493 1.498a1 1 0 01.684.949V19a2 2 0 01-2 2h-1C9.716 21 3 14.284 3 6V5z" />
                </svg>
                <span>{{ company.phone }}</span>
              </div>
              <div *ngIf="company.address" class="flex items-start gap-2 text-body-sm text-gray-600 mt-1">
                <app-map-pin-icon size="sm" variant="outline" color="text-gray-500"></app-map-pin-icon>
                <span class="flex-1">{{ company.address }}</span>
              </div>
            </div>
          </div>
        </app-card>

        <!-- Customer Data Card -->
        <app-card variant="default" [elevation]="3" padding="lg" customClass="bg-white">
          <h2 class="text-h2 font-display text-primary mb-6">Dados do Cliente</h2>
          
          <form (ngSubmit)="onSubmit()" class="space-y-6">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
              <app-input
                label="Nome"
                type="text"
                [(ngModel)]="formData.customerName"
                name="customerName"
                [required]="!isAuthenticated"
                [readonly]="isAuthenticated && customerDataLoaded"
                [autocomplete]="'name'"
                [helperText]="isAuthenticated && customerDataLoaded ? 'Preenchido automaticamente' : undefined">
              </app-input>

              <app-input
                label="Email"
                type="email"
                [(ngModel)]="formData.customerEmail"
                name="customerEmail"
                [required]="!isAuthenticated"
                [readonly]="isAuthenticated && customerDataLoaded"
                [autocomplete]="'email'"
                [helperText]="isAuthenticated && customerDataLoaded ? 'Preenchido automaticamente' : undefined">
              </app-input>

              <app-input
                label="Telefone"
                type="tel"
                [(ngModel)]="formData.customerPhone"
                name="customerPhone"
                [required]="!isAuthenticated"
                [readonly]="isAuthenticated && customerDataLoaded"
                [autocomplete]="'tel'"
                [helperText]="isAuthenticated && customerDataLoaded ? 'Preenchido automaticamente' : undefined"
                (input)="onPhoneInput($event)">
              </app-input>
            </div>

            <!-- Customer Address Section -->
            <div>
              <label class="block text-body-sm font-medium text-primary mb-2 flex items-center gap-2">
                <app-map-pin-icon size="sm" variant="filled" color="text-primary-light"></app-map-pin-icon>
                Endere√ßo de Entrega *
              </label>
              
              <!-- Dropdown de Endere√ßos Salvos (se autenticado e tiver endere√ßos) -->
              <div *ngIf="isAuthenticated && savedAddresses.length > 0" class="mb-4">
                <app-select
                  [(ngModel)]="selectedAddressId"
                  name="selectedAddress"
                  [ngModelOptions]="{standalone: true}"
                  (ngModelChange)="onAddressSelected($event)"
                  [required]="true"
                  placeholder="Selecione um endere√ßo">
                  <option value="" disabled>Selecione um endere√ßo</option>
                  <option *ngFor="let address of savedAddresses" [value]="address.id">
                    {{ address.label }} {{ address.is_default ? '(Padr√£o)' : '' }} - {{ address.address }}
                  </option>
                </app-select>
              </div>

              <!-- Bot√£o para Adicionar Endere√ßo (se autenticado mas n√£o tiver endere√ßos) -->
              <div *ngIf="isAuthenticated && savedAddresses.length === 0" class="mb-4">
                <div class="p-4 bg-info/10 border border-info/20 rounded-lg">
                  <p class="text-body-sm text-gray-700 mb-3">
                    Voc√™ ainda n√£o possui endere√ßos salvos. Adicione um endere√ßo para facilitar seus pr√≥ximos pedidos.
                  </p>
                  <app-button
                    variant="outline"
                    size="md"
                    label="+ Adicionar Endere√ßo"
                    (clicked)="goToAddAddress()"
                    customClass="w-full sm:w-auto">
                  </app-button>
                </div>
              </div>

              <!-- Campo de Endere√ßo (apenas se n√£o autenticado OU se n√£o houver endere√ßos salvos OU se selecionou "novo endere√ßo") -->
              <div *ngIf="!isAuthenticated || savedAddresses.length === 0 || (isAuthenticated && savedAddresses.length > 0 && !selectedAddressId)">
                <label class="block text-body-sm font-medium text-primary mb-2 flex items-center gap-2">
                  <app-map-pin-icon size="sm" variant="filled" color="text-primary-light"></app-map-pin-icon>
                  Endere√ßo de Entrega *
                </label>
                <textarea [(ngModel)]="formData.customerAddress"
                          name="customerAddress"
                          [required]="!isAuthenticated || savedAddresses.length === 0 || !selectedAddressId"
                          rows="3"
                          placeholder="Digite o endere√ßo completo (rua, n√∫mero, complemento, bairro, cidade - UF)"
                          autocomplete="street-address"
                          (input)="onAddressChange()"
                          (blur)="onAddressChange()"
                          class="w-full px-4 py-2.5 border border-gray-300 rounded-medium text-body focus:ring-2 focus:ring-primary-light focus:border-transparent transition-all"></textarea>
              </div>
            </div>

            <!-- Notes -->
            <div>
              <label class="block text-body-sm font-medium text-primary mb-2">Observa√ß√µes</label>
              <textarea [(ngModel)]="formData.notes"
                        name="notes"
                        rows="3"
                        class="w-full px-4 py-2.5 border border-gray-300 rounded-medium text-body focus:ring-2 focus:ring-primary-light focus:border-transparent transition-all"></textarea>
            </div>

            <!-- Payment Method -->
            <div>
              <label class="block text-body-sm font-medium text-primary mb-3">Forma de Pagamento</label>
              <div class="space-y-3">
                <label class="flex items-center p-3 border-2 border-gray-200 rounded-medium hover:border-primary-light transition-colors cursor-pointer bg-white">
                  <input type="radio" 
                         [(ngModel)]="formData.paymentMethod"
                         name="paymentMethod"
                         value="PIX"
                         (change)="onPaymentMethodChange()"
                         class="w-4 h-4 text-primary-light focus:ring-primary-light mr-3">
                  <span class="text-body text-primary font-medium">PIX</span>
                </label>
                <label class="flex items-center p-3 border-2 border-gray-200 rounded-medium hover:border-primary-light transition-colors cursor-pointer bg-white">
                  <input type="radio" 
                         [(ngModel)]="formData.paymentMethod"
                         name="paymentMethod"
                         value="CREDIT_CARD"
                         (change)="onPaymentMethodChange()"
                         class="w-4 h-4 text-primary-light focus:ring-primary-light mr-3">
                  <span class="text-body text-primary font-medium">Cart√£o de Cr√©dito (pagamento na entrega)</span>
                </label>
                <label class="flex items-center p-3 border-2 border-gray-200 rounded-medium hover:border-primary-light transition-colors cursor-pointer bg-white">
                  <input type="radio" 
                         [(ngModel)]="formData.paymentMethod"
                         name="paymentMethod"
                         value="PENDING"
                         (change)="onPaymentMethodChange()"
                         class="w-4 h-4 text-primary-light focus:ring-primary-light mr-3">
                  <span class="text-body text-primary font-medium">Definir depois</span>
                </label>
              </div>
            </div>

            <!-- Coupon Section - Mobile-First Design -->
            <div class="bg-gradient-to-br from-accent/5 to-accent/10 border-2 border-accent/20 rounded-large p-4 md:p-6">
              <div class="flex items-center gap-2 mb-4">
                <span class="text-2xl">üéüÔ∏è</span>
                <h3 class="text-body font-semibold text-primary">Tem um cupom?</h3>
              </div>
              
              <!-- Coupon Input Group -->
              <div class="flex flex-col sm:flex-row gap-3 mb-3">
                <div class="flex-1 relative">
                  <input 
                    type="text"
                    [(ngModel)]="couponCode"
                    name="couponCode"
                    (ngModelChange)="onCouponChange()"
                    [disabled]="couponApplied"
                    placeholder="Digite o c√≥digo do cupom"
                    class="w-full px-4 py-3 border-2 rounded-medium text-body font-medium uppercase tracking-wider transition-all min-h-[48px]"
                    [ngClass]="{
                      'border-success bg-success/5 text-success': couponApplied,
                      'border-error bg-error/5': couponError && !validatingCoupon,
                      'border-gray-300 bg-white focus:border-accent focus:ring-2 focus:ring-accent/20': !couponApplied && !couponError
                    }"
                    maxlength="20">
                  <span *ngIf="validatingCoupon" 
                        class="absolute right-3 top-1/2 transform -translate-y-1/2">
                    <svg class="animate-spin h-5 w-5 text-accent" fill="none" viewBox="0 0 24 24">
                      <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                      <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                    </svg>
                  </span>
                </div>
                <app-button 
                  *ngIf="!couponApplied"
                  variant="accent"
                  size="md"
                  label="Aplicar"
                  [disabled]="validatingCoupon || !couponCode || couponCode.length < 3"
                  [loading]="validatingCoupon"
                  (clicked)="applyCoupon()"
                  customClass="sm:w-auto w-full min-h-[48px]">
                </app-button>
                <app-button 
                  *ngIf="couponApplied"
                  variant="secondary"
                  size="md"
                  label="Remover"
                  (clicked)="clearCoupon()"
                  customClass="sm:w-auto w-full min-h-[48px]">
                </app-button>
              </div>
              
              <!-- Success Message -->
              <div *ngIf="couponApplied && couponDiscountAmount > 0" 
                   class="flex items-start gap-2 p-3 bg-success/10 border border-success/20 rounded-medium mb-3">
                <span class="text-lg">‚úì</span>
                <div class="flex-1">
                  <p class="text-body-sm font-semibold text-success">Cupom aplicado!</p>
                  <p class="text-body-sm text-gray-700">
                    Voc√™ economizou <span class="font-bold text-success">{{ formatCurrency(couponDiscountAmount) }}</span> neste pedido üéâ
                  </p>
                </div>
              </div>
              
              <!-- Error Message -->
              <div *ngIf="couponError && !validatingCoupon && !couponApplied" 
                   class="flex items-start gap-2 p-3 bg-error/10 border border-error/20 rounded-medium mb-3">
                <span class="text-lg">‚úï</span>
                <p class="text-body-sm text-error">{{ couponError }}</p>
              </div>
              
              <!-- Link to View Available Coupons -->
              <button 
                type="button"
                (click)="openCouponsModal()"
                class="text-body-sm text-accent font-medium hover:text-accent-dark hover:underline transition-all flex items-center gap-1">
                <span>Ver cupons dispon√≠veis</span>
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
                </svg>
              </button>
            </div>

            <app-button 
              type="submit"
              variant="accent"
              size="lg"
              [label]="processingOrder ? 'Processando...' : 'Finalizar Pedido'"
              [loading]="processingOrder"
              [disabled]="processingOrder || !isFormValid()"
              [fullWidth]="true"
              customClass="shadow-lg shadow-accent/20">
            </app-button>
          </form>
        </app-card>
      </div>

      <!-- Summary -->
      <div class="lg:col-span-1">
        <app-card variant="default" [elevation]="3" padding="lg" customClass="sticky top-4 bg-white">
          <h2 class="text-h2 font-display text-primary mb-6">Resumo do Pedido</h2>
          
          <div class="space-y-3 mb-6">
            <div *ngFor="let item of cart.items" class="flex justify-between text-body-sm">
              <span class="text-gray-600">{{ item.productName || 'Produto' }} x{{ item.quantity }}</span>
              <span class="font-semibold text-primary">{{ formatCurrency(item.subtotalCents) }}</span>
            </div>
            
            <div class="border-t border-gray-200 pt-4 space-y-3">
              <div class="flex justify-between">
                <span class="text-body text-gray-600">Subtotal</span>
                <span class="text-body font-semibold text-primary">{{ formatCurrency(cart.subtotalCents) }}</span>
              </div>
              <div *ngIf="cart.discountAmountCents > 0" class="flex justify-between text-success">
                <span class="text-body">Desconto</span>
                <span class="text-body font-semibold">-{{ formatCurrency(cart.discountAmountCents) }}</span>
              </div>
              
              <!-- Coupon Discount -->
              <div *ngIf="couponApplied && couponDiscountAmount > 0" class="flex justify-between text-success">
                <span class="text-body flex items-center gap-1">
                  <span>üéüÔ∏è</span>
                  Cupom
                  <span class="text-xs font-mono bg-success/10 px-2 py-0.5 rounded">{{ couponCode }}</span>
                </span>
                <span class="text-body font-semibold">-{{ formatCurrency(couponDiscountAmount) }}</span>
              </div>
              
              <!-- Club Benefits Section -->
              <div *ngIf="clubSubscription && clubSubscription.status === 'active'" 
                   class="bg-accent/10 -mx-6 px-6 py-4 border-y border-accent/20">
                <div class="flex items-center gap-2 mb-3">
                  <span class="text-xl">üéâ</span>
                  <span class="text-body font-semibold text-accent">Benef√≠cios do Clube</span>
                  <app-badge variant="accent" size="sm" [label]="clubSubscription.club?.name || 'Premium'"></app-badge>
                </div>
                
                <!-- Club Discount -->
                <div *ngIf="clubDiscountAmount > 0" class="flex justify-between text-success mb-2">
                  <span class="text-body-sm flex items-center gap-1">
                    <span>üí∞</span>
                    Desconto {{ clubSubscription.club?.discountPercentage }}%
                  </span>
                  <span class="text-body-sm font-semibold">-{{ formatCurrency(clubDiscountAmount) }}</span>
                </div>
                
                <!-- Free Shipping -->
                <div *ngIf="hasFreeShipping && deliveryFee > 0" class="flex justify-between text-success">
                  <span class="text-body-sm flex items-center gap-1">
                    <span>üöö</span>
                    Frete Gr√°tis
                  </span>
                  <span class="text-body-sm font-semibold">-{{ formatCurrency(deliveryFee) }}</span>
                </div>
                
                <!-- Total Savings -->
                <div *ngIf="clubDiscountAmount > 0 || (hasFreeShipping && deliveryFee > 0)" 
                     class="flex justify-between pt-2 mt-2 border-t border-accent/20">
                  <span class="text-body-sm font-semibold text-success">Voc√™ economizou:</span>
                  <span class="text-body font-bold text-success">
                    {{ formatCurrency(clubDiscountAmount + (hasFreeShipping ? deliveryFee : 0)) }}
                  </span>
                </div>
              </div>
              
              <div class="flex justify-between">
                <span class="text-body text-gray-600 flex items-center gap-1">
                  <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16V6a1 1 0 00-1-1H4a1 1 0 00-1 1v10a1 1 0 001 1h1m8-1a1 1 0 01-1 1H9m4-1V8a1 1 0 011-1h2.586a1 1 0 01.707.293l3.414 3.414a1 1 0 01.293.707V16a1 1 0 01-1 1h-1m-6-1a1 1 0 001 1h1M5 17a2 2 0 104 0m-4 0a2 2 0 114 0m-4 0v1a1 1 0 001 1h2m-6 0h6" />
                  </svg>
                  Frete
                  <span *ngIf="loadingFee" class="text-xs text-gray-400">(calculando...)</span>
                </span>
                <span class="text-body font-semibold" 
                      [ngClass]="hasFreeShipping && deliveryFee > 0 ? 'text-success line-through' : 'text-primary'">
                  <span *ngIf="deliveryFee > 0 && !hasFreeShipping">{{ formatCurrency(deliveryFee) }}</span>
                  <span *ngIf="deliveryFee > 0 && hasFreeShipping" class="text-success">
                    {{ formatCurrency(deliveryFee) }}
                    <span class="ml-2 no-underline font-bold">GR√ÅTIS</span>
                  </span>
                  <span *ngIf="deliveryFee === 0 && !loadingFee && !hasFreeShipping" class="text-gray-400">A calcular</span>
                  <span *ngIf="loadingFee" class="text-gray-400">...</span>
                </span>
              </div>
              <div *ngIf="feeError" class="text-xs text-error flex items-center gap-1">
                <svg class="w-3 h-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                {{ feeError }}
              </div>
              <div class="flex justify-between pt-2 border-t border-gray-200">
                <span class="text-h3 font-bold text-primary">Total</span>
                <span class="text-h3 font-bold text-primary-light">
                  {{ formatCurrency(clubSubscription && clubSubscription.status === 'active' ? getTotalWithClubBenefits() : getTotalWithDelivery()) }}
                </span>
              </div>
            </div>
          </div>

          <div class="border-t border-gray-200 pt-4 space-y-3">
            <div class="flex items-start gap-2">
              <app-map-pin-icon size="sm" variant="filled" color="text-primary-light" class="mt-0.5 flex-shrink-0"></app-map-pin-icon>
              <div class="flex-1">
                <span class="text-body-sm text-gray-600 block mb-1">Data de Entrega:</span>
                <p class="text-body font-semibold text-primary">{{ formatDate(deliveryDate) }}</p>
              </div>
            </div>
            <div *ngIf="deliveryTime" class="flex items-start gap-2">
              <svg class="w-5 h-5 text-primary-light mt-0.5 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              <div class="flex-1">
                <span class="text-body-sm text-gray-600 block mb-1">Per√≠odo:</span>
                <p class="text-body font-semibold text-primary">{{ getTimeLabel(deliveryTime) }}</p>
              </div>
            </div>
          </div>
        </app-card>
      </div>
    </div>
  </div>

  <!-- Login Required Modal -->
  <app-modal
    [isOpen]="showLoginModal"
    title="Login Necess√°rio"
    description="Fa√ßa login para finalizar sua compra"
    confirmLabel="Fazer Login"
    cancelLabel="Cancelar"
    confirmVariant="primary"
    (confirmed)="goToLogin()"
    (cancelled)="showLoginModal = false">
  </app-modal>

  <!-- Coupons Modal -->
  <app-coupons-modal
    [isOpen]="showCouponsModal"
    [accountId]="accountId || ''"
    (closed)="closeCouponsModal()"
    (couponApplied)="applyCouponFromModal($event)">
  </app-coupons-modal>
</div>

