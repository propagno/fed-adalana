<div class="delivery-detail">
  <button class="btn-back" (click)="goBack()">‚Üê Voltar</button>

  <div *ngIf="loading" class="loading">
    <p>Carregando detalhes...</p>
  </div>

  <div *ngIf="error" class="error">
    <p>{{ error }}</p>
  </div>

  <div *ngIf="delivery && !loading" class="delivery-content">
    <header class="detail-header">
      <h1>{{ delivery.customer_name }}</h1>
      <span class="status-badge" [ngClass]="getStatusClass(delivery.status)">
        {{ delivery.status }}
      </span>
    </header>

    <div class="detail-section">
      <h2>Informa√ß√µes do Cliente</h2>
      <div class="info-grid">
        <div class="info-item">
          <strong>Nome:</strong> {{ delivery.customer_name }}
        </div>
        <div class="info-item">
          <strong>Telefone:</strong> 
          <a [href]="'tel:' + delivery.customer_phone">{{ delivery.customer_phone }}</a>
        </div>
        <div class="info-item full-width">
          <strong>Endere√ßo:</strong> {{ delivery.customer_address }}
        </div>
      </div>
    </div>

    <div class="detail-section">
      <h2>Itens da Entrega</h2>
      <table class="items-table">
        <thead>
          <tr>
            <th>Produto</th>
            <th>Quantidade</th>
            <th>Pre√ßo Unit.</th>
            <th>Total</th>
          </tr>
        </thead>
        <tbody>
          <tr *ngFor="let item of delivery.items">
            <td>{{ item.product_name }}</td>
            <td>{{ item.quantity }}</td>
            <td>{{ formatCurrency(item.unit_price) }}</td>
            <td>{{ formatCurrency(item.total_price) }}</td>
          </tr>
        </tbody>
        <tfoot>
          <tr>
            <td colspan="3"><strong>Total:</strong></td>
            <td><strong>{{ formatCurrency(delivery.total_amount) }}</strong></td>
          </tr>
        </tfoot>
      </table>
    </div>

    <div class="detail-section">
      <h2>Status do Pagamento</h2>
      <p class="payment-status" [ngClass]="getPaymentStatusClass(delivery.payment_status)">
        {{ delivery.payment_status }}
      </p>
    </div>

    <div class="detail-actions">
      <button class="btn btn-whatsapp" (click)="openWhatsApp()">
        üì± WhatsApp
      </button>
      <button class="btn btn-maps" (click)="openMaps()">
        üó∫Ô∏è Navegar
      </button>
      <button 
        *ngIf="delivery.status !== 'delivered' && delivery.status !== 'failed'"
        class="btn btn-success" 
        (click)="markAsDelivered()"
        [disabled]="actionLoading">
        ‚úì Marcar como Entregue
      </button>
      <button 
        *ngIf="delivery.status === 'delivered' && delivery.payment_status !== 'paid'"
        class="btn btn-payment" 
        (click)="recordPayment()">
        üí∞ Registrar Pagamento
      </button>
    </div>

    <div *ngIf="delivery.status !== 'delivered' && delivery.status !== 'failed'" class="detail-section">
      <h2>Marcar como Entregue</h2>
      <p class="info-text">Para confirmar a entrega, voc√™ precisar√° do c√≥digo de confirma√ß√£o (OTP) fornecido pelo cliente.</p>
      <div class="form-group">
        <label for="delivery-notes">Observa√ß√µes:</label>
        <textarea 
          id="delivery-notes" 
          [(ngModel)]="deliveryNotes" 
          rows="3"
          placeholder="Observa√ß√µes sobre a entrega..."></textarea>
      </div>
    </div>

    <div *ngIf="delivery.status !== 'delivered' && delivery.status !== 'failed'" class="detail-section">
      <h2>Marcar como Falha</h2>
      <div class="form-group">
        <label for="failure-reason">Motivo da Falha:</label>
        <select id="failure-reason" [(ngModel)]="failureReason">
          <option value="customer_absent">Cliente Ausente</option>
          <option value="address_issue">Problema com Endere√ßo</option>
          <option value="refused">Cliente Recusou</option>
          <option value="other">Outro</option>
        </select>
      </div>
      <div class="form-group">
        <label for="failure-notes">Observa√ß√µes:</label>
        <textarea 
          id="failure-notes" 
          [(ngModel)]="failureNotes" 
          rows="3"
          placeholder="Detalhes sobre a falha..."></textarea>
      </div>
      <button class="btn btn-danger" (click)="markAsFailed()" [disabled]="actionLoading">
        ‚úó Marcar como Falha
      </button>
    </div>
  </div>

  <!-- Modal para inserir c√≥digo OTP -->
  <div *ngIf="showDeliveryCodeModal" style="position:fixed;inset:0;background:rgba(0,0,0,.5);display:flex;align-items:center;justify-content:center;z-index:1000;padding:1rem" (click)="cancelDeliveryCodeModal()">
    <div style="background:#fff;border-radius:8px;max-width:500px;width:100%;box-shadow:0 10px 25px rgba(0,0,0,.2);animation:slideIn .3s ease-out" (click)="$event.stopPropagation()">
      <div style="display:flex;justify-content:space-between;align-items:center;padding:1.5rem;border-bottom:1px solid #e5e7eb">
        <h2 style="margin:0;color:#333;font-size:1.5rem">Confirmar Entrega</h2>
        <button style="background:none;border:none;font-size:2rem;color:#6b7280;cursor:pointer;padding:0;width:32px;height:32px;display:flex;align-items:center;justify-content:center;border-radius:4px" (click)="cancelDeliveryCodeModal()" onmouseover="this.style.background='#f3f4f6'" onmouseout="this.style.background='none'">√ó</button>
      </div>
      <div style="padding:1.5rem">
        <p style="color:#6b7280;font-size:.9rem;margin-bottom:1rem;padding:.75rem;background:#f3f4f6;border-radius:4px;border-left:3px solid #3b82f6">Por favor, solicite ao cliente o c√≥digo de confirma√ß√£o (OTP) de 4 d√≠gitos que foi enviado para ele.</p>
        
        <div class="form-group">
          <label for="delivery-code">C√≥digo de Confirma√ß√£o (OTP):</label>
          <input 
            type="text" 
            id="delivery-code" 
            [(ngModel)]="deliveryCode" 
            maxlength="4"
            placeholder="0000"
            style="font-size:1.5rem;text-align:center;letter-spacing:.5rem;font-weight:600;padding:1rem;border:2px solid #d1d5db;border-radius:8px;width:100%;outline:0"
            (keyup.enter)="confirmDeliveryWithCode()"
            (focus)="$any($event.target).style.borderColor='#3b82f6';$any($event.target).style.boxShadow='0 0 0 3px rgba(59,130,246,.1)'"
            (blur)="$any($event.target).style.borderColor='#d1d5db';$any($event.target).style.boxShadow='none'"
            autofocus>
          <small style="display:block;margin-top:.5rem;color:#6b7280;font-size:.875rem">Digite o c√≥digo de 4 d√≠gitos fornecido pelo cliente</small>
        </div>

        <div *ngIf="error" style="background:#fee2e2;border:1px solid #fecaca;border-radius:4px;padding:.75rem;margin-top:1rem">
          <p style="margin:0;color:#991b1b;font-size:.9rem">{{ error }}</p>
        </div>
      </div>
      <div style="display:flex;justify-content:flex-end;gap:.75rem;padding:1.5rem;border-top:1px solid #e5e7eb">
        <button class="btn btn-secondary" (click)="cancelDeliveryCodeModal()" [disabled]="actionLoading">
          Cancelar
        </button>
        <button class="btn btn-success" (click)="confirmDeliveryWithCode()" [disabled]="actionLoading || !deliveryCode || deliveryCode.trim().length === 0">
          <span *ngIf="actionLoading">Confirmando...</span>
          <span *ngIf="!actionLoading">Confirmar Entrega</span>
        </button>
      </div>
    </div>
  </div>
</div>
